---
title: "HPB trials"
---


```{r requiredlibraries}
#libraries to look at RHESSys output
library(tidyverse)
#devtools::install_github("RHESSys/RHESSysIOinR")
library(RHESSysIOinR)

```


## Mount Docker container to repo
Update the line below so it points to where you locally stored the 'RHESSys_Tutorial' project

docker run -v C:/Users/dwh18/OneDrive/Desktop/R_projects/RHESSys_Tutorial:/RHESSys/repo -it rhessys/rhessys:develop


## Open R in Docker and set working directory  

Testing data
```{r}
#### In the Docker container at base 'RHESSys/' type 'R' this will open an R session

## In that R session run this line to set working directory within the repo
setwd("repo/HPB_files")

```


## Creates the command line to run model

```{r commandlinegen}

## These lines set up where to find RHESSys model version and config files 
rhessys_ver = "../../rhessys7.5" #to point backwards to model
worldfile = "worldfiles/hpb.world"
header = "worldfiles/hpb.hdr"
flowtable = "flowtables/hpb.flow"
tecfile = "tecfiles/tec.test" 

## These set up the command line to tell the model what time frame to run and what outputs to set 
#If you want to change duration you also have to update the tec.test file to match cmd3
cmd1 = sprintf("%s -t %s -w %s -whdr %s -r %s",
                     rhessys_ver, tecfile, worldfile, header, flowtable)
cmd2 = sprintf("-pre out/HPBtest -s 0.9 650, -gw 0.1 0.9")
 cmd3 = sprintf("-st 1950 01 1 1 -ed 2025 06 1 1 -b -g")
command_line = paste(cmd1,cmd2,cmd3)

#This runs the model
system(command_line)


##all of the code above can be copied directly into the R session in the container to run the model


```


## Read in the test results 
After running the model above this code can be used to read in model output and validation data

```{r}
getwd()

##read in validation data; This is data DWH pre-compiled to compare our model run to
validation_df <- read.csv("../Data_PreProcessing/HPB_stage_chem_data.csv") |> 
  mutate(Date = ymd(Date))


## Read in RHESSys output
hpb_test = readin_rhessys_output("out/HPBtest") #most recent run that hasn't been moved to a folder

names(hpb_test)
hpb_test_bd <- hpb_test$bd
hpb_test_bdg <- hpb_test$bdg

#bind data together
output <- left_join(hpb_test_bd, hpb_test_bdg, 
                    by = c("day", "month", "year", "basinID", "wy", "yd", "date")) |> 
  select(day, month, year, date, yd, wy, basinID, everything()) |> 
  left_join(validation_df, by = c("date" = "Date"))



```


## Plot results 

stabilization plots 

```{r}

## Biogeochem Plots
output |> 
 # filter(date > ymd("1980-01-01")) |> 
  select(date, year, yd, lai.x, #surfaceN, 
         litrc.x, plantc.x, soilc, streamflow_DON, streamflow_DOC,
         streamflow_NO3, streamflow_NH4
         ) |> 
  pivot_longer(-c(1:3)) |> 
  ggplot(aes(x = date, y = value))+
  geom_point()+ 
  facet_wrap(~name, scales = "free_y", ncol = 2)


## Hydro plots
output |> 
  # filter(date > ymd("1980-01-01")) |> 
  # select(date, year, yd, streamflow, baseflow, precip, recharge, unsat_stor, 
  #        rz_storage, sat_def, 
  #        litter_store, litter_capacity, 
  #        evap, evap_can, evap_lit, evap_soil,
  #        gw.Qout, gw.storage
  #        ) |> 
  select(date, year, yd, 
         streamflow,  precip, recharge, 
         unsat_stor, evap, gw.storage
         ) |> 
  pivot_longer(-c(1:3)) |> 
  ggplot(aes(x = date, y = value))+
  geom_point()+ 
  facet_wrap(~name, scales = "free_y", ncol = 2)


```


Validation to our data

```{r}

#streamflow by year
output |> 
  filter(wy > 2020) |> 
  select(date, year, yd, streamflow, precip) |> 
  pivot_longer(-c(1:3)) |> 
  ggplot(aes(x = yd, y = value, color = as.factor(year) ))+
  geom_line(size = 1.2)+
  facet_wrap(~name, scales = "free_y", nrow = 2)


#HPB watershed is 4241374 m^2  
#streamflow from model is in mm (mm to m ==  mm/1000)
rhessys_Q <- output |> 
  filter(year > 2020) |> 
  select(date, year, yd, streamflow, precip, flowmate_L_s, Q_L_s_stage) |> 
  mutate(streamflow_cmday = (streamflow / 1000 ) * (4241374),
         streamflow_cms = streamflow_cmday / 86400
         ) |> 
  mutate(rhessys_Q_L_s = streamflow_cms * 1000)


rhessys_Q |> 
  filter(date >= ymd("2024-01-01")) |> 
  select(date, rhessys_Q_L_s, Q_L_s_stage ) |> 
  pivot_longer(-1) |> 
  ggplot(aes(x = date, y = value, color = name))+
  geom_line(size = 1.2)+
  theme_bw()+
  labs(x = "Date", y = "Discharge (L/s)")
  
rhessys_Q |> 
  ggplot()+
  geom_line(aes(x = date, y = rhessys_Q_L_s), size = 1)+
  geom_point(aes(x = date, y = flowmate_L_s), color = "red", size = 3)+
  theme_bw()+
  labs(x = "Date", y = "Discharge (L/s)")



###NO3 conversions check
#assuimg gN/m2/day
output |> 
  filter(year > 2020) |> 
  select(date, year, yd, streamflow, precip, streamflow_NO3, NO3NO2_ugL) |> 
  mutate(NO3_mgL_AL = NO3NO2_ugL / 1000) |> 
  mutate(streamflow_cmday = (streamflow / 1000 ) * (4241374),
         streamflow_cms = streamflow_cmday / 86400
         ) |> 
  mutate(rhessys_Q_L_s = streamflow_cms * 1000) |> 
  mutate(NO3_gN_day = streamflow_NO3 * (4241374)) |> 
  mutate(Q_L_day = rhessys_Q_L_s * 86400) |> 
  mutate(NO3_g_L = NO3_gN_day / Q_L_day) |> 
  mutate(NO3_mg_L = NO3_g_L * 1000) |> 
  ggplot(aes(x= date, y = NO3_mg_L))+
  geom_point()+
  geom_point(aes(x= date, y = NO3_mgL_AL ), color = "red")


###DOC conversions check
output |> 
  #filter(year > 2020) |> 
  select(date, year, yd, streamflow, precip, streamflow_DOC, DOC_mgL) |>
  rename(DOC_mgL_AL = DOC_mgL) |> 
  mutate(streamflow_cmday = (streamflow / 1000 ) * (4241374),
         streamflow_cms = streamflow_cmday / 86400
         ) |> 
  mutate(rhessys_Q_L_s = streamflow_cms * 1000) |> 
  mutate(DOC_gC_day = streamflow_DOC * (4241374)) |> 
  mutate(Q_L_day = rhessys_Q_L_s * 86400) |> 
  mutate(DOC_g_L = DOC_gC_day / Q_L_day) |> 
  mutate(DOC_mg_L = DOC_g_L * 1000) |> 
  filter(DOC_mg_L < 20) |> 
  ggplot(aes(x= date, y = DOC_mg_L))+
  geom_point() +
  geom_point(aes(x= date, y = DOC_mgL_AL ), color = "red")




```

